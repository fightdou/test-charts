apiVersion: v1
kind: ConfigMap
metadata:
  name: keystone-etc
  namespace: {{ .Release.Namespace | quote }}
data:
  keystone.conf: |-
    [DEFAULT]
    debug = False
    transport_url = {{ index .Values "openstack-dep" "openstackEnv" "rabbitmqUrl" }}
    log_file = /var/log/kolla/keystone/keystone.log
    use_stderr = True

    [oslo_middleware]
    enable_proxy_headers_parsing = True

    [database]
    connection = mysql+pymysql://{{ include "keystone.databaseUser" . }}:{{ include "keystone.databasePassword" . }}@{{ index .Values "openstack-dep" "openstackEnv" "mariadbUrl" }}/{{ include "keystone.databaseName" . }}
    connection_recycle_time = 10
    max_pool_size = 1
    max_retries = -1

    [token]
    revoke_by_id = False
    provider = fernet
    expiration = 86400
    allow_expired_window = 172800

    [fernet_tokens]
    max_active_keys = 3

    [cache]
    backend = oslo_cache.memcache_pool
    enabled = True
    memcache_servers = {{ index .Values "openstack-dep" "openstackEnv" "memcacheUrl" }}

    [oslo_messaging_notifications]
    transport_url = {{ index .Values "openstack-dep" "openstackEnv" "rabbitmqUrl" }} 
    driver = messagingv2
    topics = barbican_notifications
  keystone-api.json: |-
    {
      "command": "/usr/bin/keystone-startup.sh",
      "config_files": [
          {
              "source": "/var/lib/kolla/config_files/keystone-startup.sh",
              "dest": "/usr/bin/keystone-startup.sh",
              "owner": "root",
              "perm": "0755"
          },
          {
              "source": "/var/lib/kolla/config_files/keystone.conf",
              "dest": "/etc/keystone/keystone.conf",
              "owner": "keystone",
              "perm": "0600"
          },
          {
              "source": "/var/lib/kolla/config_files/wsgi-keystone.conf",
              "dest": "/etc/apache2/conf-enabled/wsgi-keystone.conf",
              "owner": "keystone",
              "perm": "0600"
          }
      ],
      "permissions": [
          {
              "path": "/var/log/kolla",
              "owner": "keystone:kolla"
          },
          {
              "path": "/var/log/kolla/keystone/keystone.log",
              "owner": "keystone:keystone"
          }
      ]
    }
  keystone-startup.sh: |-
    #!/bin/bash -x
    set -o errexit
    set -o pipefail

    FERNET_KEY_DIR="/etc/keystone/fernet-keys"

    # Ensure Fernet keys are populated, check for 0 (staging) key
    n=0
    while [ ! -f "${FERNET_KEY_DIR}/0" ]; do
        if [ $n -lt 36 ]; then
            n=$(( n + 1 ))
            echo "ERROR: Fernet keys have not been populated, rechecking in 5 seconds"
            echo "DEBUG: ${FERNET_KEY_DIR} contents:"
            ls -l ${FERNET_KEY_DIR}
            sleep 5
        else
            echo "CRITICAL: Waited for 3 minutes - failing"
            exit 1
        fi
    done

    exec /usr/sbin/apache2 $@
  wsgi-keystone.conf: |-
    Listen 0.0.0.0:5000
    Listen 0.0.0.0:35357

    ServerSignature Off
    ServerTokens Prod
    TraceEnable off

    ErrorLog "/var/log/kolla/keystone/apache-error.log"
    <IfModule log_config_module>
        CustomLog "/var/log/kolla/keystone/apache-access.log" common
    </IfModule>

    <Directory "/var/lib/kolla/venv/bin/">
        <FilesMatch "^keystone-wsgi-(public|admin)$">
            AllowOverride None
            Options None
            Require all granted
        </FilesMatch>
    </Directory>

    <VirtualHost *:5000>
        WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP} python-path=/var/lib/kolla/venv/lib/python3.8/site-packages
        WSGIProcessGroup keystone-public
        WSGIScriptAlias / /var/lib/kolla/venv/bin/keystone-wsgi-public
        WSGIApplicationGroup %{GLOBAL}
        WSGIPassAuthorization On
        <IfVersion >= 2.4>
          ErrorLogFormat "%{cu}t %M"
        </IfVersion>
        ErrorLog "/var/log/kolla/keystone/keystone-apache-public-error.log"
        LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b %D \"%{Referer}i\" \"%{User-Agent}i\"" logformat
        CustomLog "/var/log/kolla/keystone/keystone-apache-public-access.log" logformat

    </VirtualHost>

    <VirtualHost *:35357>
        WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP} python-path=/var/lib/kolla/venv/lib/python3.8/site-packages
        WSGIProcessGroup keystone-admin
        WSGIScriptAlias / /var/lib/kolla/venv/bin/keystone-wsgi-admin
        WSGIApplicationGroup %{GLOBAL}
        WSGIPassAuthorization On
        <IfVersion >= 2.4>
          ErrorLogFormat "%{cu}t %M"
        </IfVersion>
        ErrorLog "/var/log/kolla/keystone/keystone-apache-admin-error.log"
        LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %>s %b %D \"%{Referer}i\" \"%{User-Agent}i\"" logformat
        CustomLog "/var/log/kolla/keystone/keystone-apache-admin-access.log" logformat

    </VirtualHost>
  keystone-db-sync.json: |-
    {
      "command": "/tmp/db-sync.sh",
      "config_files": [
          {
              "source": "/var/lib/kolla/config_files/keystone.conf",
              "dest": "/etc/keystone/keystone.conf",
              "owner": "keystone",
              "perm": "0600"
          }
      ],
      "permissions": [
          {
              "path": "/var/log/kolla",
              "owner": "keystone:kolla"
          },
          {
              "path": "/var/log/kolla/keystone/keystone.log",
              "owner": "keystone:keystone"
          }
      ]
    }
